---
title: "Final Project 320 - NBA"
author: "Justin De Burgo, Sherief El-Ghazawi, Josue Arana"
date: "5/18/2020"
output: html_document
---

Things to consider 

## Motivation 
Does the tutorial make the reader believe the topic is relevant or important (i) in general and (ii) with respect to data science?

## Understanding. 
After reading through the tutorial, does an uninformed reader feel informed about the topic? Would a reader who already knew about the topic feel like s/he learned more about it?

## Other resources. 
Does the tutorial link out to other resources (on the web, in books, etc) that would give a lagging reader additional help on specific topics, or an advanced reader the ability to dive more deeply into a specific application area or technique?

## Prose. 
Does the prose portion of the tutorial actually add to the content of the deliverable?

## Code. 
Is the code well written, well documented, reproducible, and does it help the reader understand the tutorial? Does it give good examples of specific techniques?

## Subjective evaluation. 
If somebody linked to this tutorial from, say, Hacker News, would people actually read through the entire thing?
Group Work


## Data Collection 

First let's import the packages and libraries we'll need.
```{r setup, include=TRUE}
library(tidyverse)
library(ggplot2)
```

We'll read the CSV and turn it into an R DataFrame for further analysis.

```{r nba_seasons, inlciude=TRUE}
nba_seasons <- read_csv("NBA_Season_Data.csv")
nba_seasons1 <- nba_seasons%>%
                filter(Year >= 2000) 
nba_seasons1
distinct(nba_seasons1, Tm)
```




```{r nba_finals_mvp}
nba_finals_mvp <- read_csv("NBA_Finals_and_MVP.csv")
nba_finals_mvp <- nba_finals_mvp%>%
                filter(Year >= 2000) 
for (row in 1:nrow(nba_finals_mvp)) {
  
 if (nba_finals_mvp[row, "NBA Champion"] == "Los Angeles Lakers") {
   nba_finals_mvp[row, "NBA Champion"] <- "LAL"
 }
  
  if (nba_finals_mvp[row, "NBA Champion"] == "Golden State Warriors") {
   nba_finals_mvp[row, "NBA Champion"] <- "GSW"
  }
  
  if ( nba_finals_mvp[row, "NBA Champion"] == "Cleveland Cavaliers") {
   nba_finals_mvp[row, "NBA Champion"] <- "CLE"
  }
  
  if (nba_finals_mvp[row, "NBA Champion"] == "San Antonio Spurs") {
   nba_finals_mvp[row, "NBA Champion"] <- "SAS"
  }
  
  
  if ( nba_finals_mvp[row, "NBA Champion"] == "Miami Heat") {
   nba_finals_mvp[row, "NBA Champion"] <- "MIA"
  }
  
  if (nba_finals_mvp[row, "NBA Champion"] == "Dallas Mavericks") {
   nba_finals_mvp[row, "NBA Champion"] <- "DAL"
  }
  
  if (nba_finals_mvp[row, "NBA Champion"] == "Boston Celtics") {
   nba_finals_mvp[row, "NBA Champion"] <- "BOS"
  }
  
  if (nba_finals_mvp[row, "NBA Champion"] == "Detroit Pistons") {
   nba_finals_mvp[row, "NBA Champion"] <- "DET"
  }
  
}
```


```{r nba_performances, include=TRUE}
nba_performance <- read_csv("Historical_NBA_Performance.csv")
nba_performance <- nba_performance%>%
                filter(Year >= 2000) 
for (row in 1:nrow(nba_performance)) {
  
  if (nba_performance[row, "Team"] == "Nets") {
   nba_performance[row, "Team"] <- "BRK"
 }
  
  if (nba_performance[row, "Team"] == "Thunder") {
   nba_performance[row, "Team"] <- "OKC"
 }
  
  if (nba_performance[row, "Team"] == "Pelicans") {
   nba_performance[row, "Team"] <- "NOP"
 }
  
  if (nba_performance[row, "Team"] == "Grizzlies") {
   nba_performance[row, "Team"] <- "MEM"
 }
  
  if (nba_performance[row, "Team"] == "Magic") {
   nba_performance[row, "Team"] <- "ORL"
 }
  
  if (nba_performance[row, "Team"] == "Clippers") {
   nba_performance[row, "Team"] <- "LAC"
 }
  
  if (nba_performance[row, "Team"] == "Rockets") {
   nba_performance[row, "Team"] <- "HOU"
 }
  
  if (nba_performance[row, "Team"] == "Suns") {
   nba_performance[row, "Team"] <- "PHO"
 }
  
  if (nba_performance[row, "Team"] == "Trail Blazers") {
   nba_performance[row, "Team"] <- "POR"
 }
  
  if (nba_performance[row, "Team"] == "76ers") {
   nba_performance[row, "Team"] <- "PHI"
 }
  
  if (nba_performance[row, "Team"] == "Kings") {
   nba_performance[row, "Team"] <- "SAC"
 }
  
  
  if (nba_performance[row, "Team"] == "Wizards") {
   nba_performance[row, "Team"] <- "WAS"
 }
  
  if (nba_performance[row, "Team"] == "Jazz") {
   nba_performance[row, "Team"] <- "UTA"
 }
  
  if (nba_performance[row, "Team"] == "Nuggets") {
   nba_performance[row, "Team"] <- "DEN"
 }
  
  if (nba_performance[row, "Team"] == "Hawks") {
   nba_performance[row, "Team"] <- "ATL"
  }
  
  if (nba_performance[row, "Team"] == "Pacers") {
   nba_performance[row, "Team"] <- "IND"
 }
  
  if (nba_performance[row, "Team"] == "Bulls") {
   nba_performance[row, "Team"] <- "CHI"
 }
  
  if (nba_performance[row, "Team"] == "Hornets" || nba_performance[row, "Team"] == "Bobcats") {
   nba_performance[row, "Team"] <- "CHH"
 }
  
  if (nba_performance[row, "Team"] == "Bucks") {
   nba_performance[row, "Team"] <- "MIL"
 }
  
  if (nba_performance[row, "Team"] == "Raptors") {
   nba_performance[row, "Team"] <- "TOR"
 }
  
  if (nba_performance[row, "Team"] == "Timberwolves") {
   nba_performance[row, "Team"] <- "MIN"
 }
  
  if (nba_performance[row, "Team"] == "Knicks") {
   nba_performance[row, "Team"] <- "NYK"
 }
  
   if (nba_performance[row, "Team"] == "Supersonics") {
   nba_performance[row, "Team"] <- "SEA"
 }
  
 if (nba_performance[row, "Team"] == "Lakers") {
   nba_performance[row, "Team"] <- "LAL"
 }
  
  if (nba_performance[row, "Team"] == "Warriors") {
   nba_performance[row, "Team"] <- "GSW"
  }
  
  if ( nba_performance[row, "Team"] == "Cavaliers") {
   nba_performance[row, "Team"] <- "CLE"
  }
  
  if (nba_performance[row, "Team"] == "Spurs") {
   nba_performance[row, "Team"] <- "SAS"
  }
  
  
  if ( nba_performance[row, "Team"] == "Heat") {
   nba_performance[row, "Team"] <- "MIA"
  }
  
  if (nba_performance[row, "Team"] == "Mavericks") {
   nba_performance[row, "Team"] <- "DAL"
  }
  
  if (nba_performance[row, "Team"] == "Celtics") {
   nba_performance[row, "Team"] <- "BOS"
  }
  
  if (nba_performance[row, "Team"] == "Pistons") {
   nba_performance[row, "Team"] <- "DET"
  }
  
}
distinct(nba_performance, Team)
nba_performance
```




```{r nba_champs, include=TRUE}
nba_champs <- select(nba_finals_mvp, 1, 5) %>%
                filter(Year >= 2000) %>%
                arrange(desc(Year))
nba_champs
```


```{r nba_seasons_offense, include=TRUE}
nba_seasons_offense <- select(nba_seasons1, Year, Tm, Player, Offense=Offense_1, Defense = Defense_1)
nba_seasons_offense
nba_seasons_offense %>%
  arrange(desc(Offense)) %>%
  slice(1:100)
```


```{r offense, include=TRUE}
offense <- nba_seasons_offense %>%
              filter(Year >= 2000) %>%
              group_by(Year, Tm) %>%
              summarize(mean_offense=sum(Offense), mean_defense=sum(Defense))
offense <- offense %>%
            arrange(desc(mean_offense))
offense
```

```{r change_names, include=TRUE}
offense %>%
  arrange(desc(Year)) 
```

```{r year_avg, include=TRUE}
year_avg <- offense%>%
              group_by(Year)%>%
              summarize(league_avg_offense=mean(mean_offense), league_avg_defense=mean(mean_defense))
year_avg
```

```{r offense_champs, include=TRUE}
offense_champs <- left_join(nba_champs, offense, by=c("Year"="Year", "NBA Champion"="Tm"))
offense_champs <- offense_champs %>%
                    filter(mean_offense > -100000)
offense_champs<-rename(offense_champs, champ="NBA Champion")
offense_champs
```


```{r plot_offense, include=TRUE}
offense_champs %>%
  ggplot(mapping=aes(x=champ, y=mean_offense, color="red", width=0.5)) +
    geom_bar(stat="identity")
par(mar=c(11,4,4,4))
test2 <- rbind(offense_champs$mean_offense,offense_champs$mean_defense, year_avg$league_avg_offense, year_avg$league_avg_defense)
barplot(test2,beside=T, names.arg = offense_champs$champ, las=2, legend = T)
legend("right", 
       legend = c("Mean Offense", "Mean Defense", "League avg Offense", "League avg Defense"), 
       fill = c("grey", "dimgrey", "red", "blue"),
       bty = "n",
       cex = 0.5)
```



```{r performances}
performances <- nba_performance
performances <- performances %>% select(Year, Team, `Winning Percentage`) %>% arrange(Year)
performances$Year <- substr(performances$Year, 1, 4) %>% as.numeric()
performances
```



```{r payroll}
payroll_df <- read_csv("NBA_Season_Data.csv")
payroll_df$TrueSalary <- as.numeric(gsub("[$,]", "", payroll_df$TrueSalary))
payroll_df <- payroll_df %>% filter(!is.na(TrueSalary))
payroll_df <- payroll_df %>% filter(Year > 2000) %>% 
  group_by(Tm, Year) %>% 
  mutate(payroll=sum(TrueSalary), PER_year=mean(PER)) %>% 
  distinct(Year, Tm, payroll, PER_year)
payroll_df

classify <- function(yearID) {
  if (yearID >= 2000 && yearID <= 2004) "[2000,2004]"
  else if (yearID > 2004 && yearID <= 2009) "(2004,2009]"
  else if (yearID > 2009 && yearID <= 2013) "(2009,2013]"
  else if (yearID > 2013 && yearID <= 2016) "(2013,2016]"
}

times <- c("[2000,2004]", "(2004,2009]", "(2009,2013]", "(2013,2016]")

payroll_df <- payroll_df %>%
                      mutate(time_period = classify(Year))
payroll_df

winnings <- payroll_df %>% group_by(Tm, time_period) %>% mutate(avg_PER=mean(PER_year), avg_Spending=mean(payroll)) %>% distinct(Tm, avg_PER, avg_Spending)


for (t in times) {
  x <- filter(winnings, time_period == t)
  print(x %>%
      ggplot(aes(x=avg_Spending, y=avg_PER, label=Tm)) +
      facet_grid(~time_period) +
      geom_text() +
      geom_point() +
      geom_smooth(method=lm))
  
}

```


## Exploratory data analysis

```{r moneyball}
moneyball <- left_join(performances, payroll_df, by=c("Year" = "Year", "Team" = "Tm"))
moneyball <- moneyball %>% filter(!is.na(payroll))
moneyball <- rename(moneyball, win_p = "Winning Percentage")
moneyball
winnings <- moneyball %>% group_by(Team, time_period) %>% mutate(avg_Spending=mean(payroll), win_percentage=mean(win_p)) %>% distinct(Tm, avg_Spending, win_percentage)

winnings
for (t in times) {
  x <- filter(winnings, time_period == t)
  print(x %>%
      ggplot(aes(x=avg_Spending, y=win_percentage, label=Team)) +
      facet_grid(~time_period) +
      geom_text() +
      geom_point() +
      geom_smooth(method=lm))
  
}
```

```{r trans}


time_period_df <- moneyball %>% 
  group_by(Team, time_period) %>% 
  mutate(avg_winPct = mean(win_p), avg_payroll = mean(payroll), efficiency = avg_winPct/avg_payroll, time_pd=cut(Year,breaks=4)) %>% 
  arrange(time_period)

time_period_df %>%
  ggplot(aes(x=Team, y=efficiency, label=Team)) +
    facet_grid(~time_period) +
    geom_bar(stat="identity") +
 theme(axis.text.x = element_text(face="bold",
                           size=4, angle=90),
          axis.text.y = element_text(face="bold", 
                           size=14, angle=45))

```

In this section we want to know and visualize the correlation between the payroll and the winning percentage in the NBA database. By doing this it will help us understando the importance of the payroll amound among the teams and compare it to the NBA Champions during five time periods.

```{r moneyball}
nba_data <- left_join(performances, payroll_df, by=c("Year" = "Year", "Team" = "Tm"))
nba_data <- nba_data %>% filter(!is.na(payroll))

nba_data <- rename(nba_data, win_p = "Winning Percentage")
winnings <- nba_data %>% group_by(Team, time_period) %>% mutate(avg_Spending=mean(payroll), win_percentage=mean(win_p)) %>% distinct(Tm, avg_Spending, win_percentage)

## left join
nba_data <- sqldf("SELECT m.*, (m.Team = off.champ) as champs
              FROM moneyball as m
              LEFT JOIN offense_champs as off ON m.Year = off.Year")

nba_data$is_champ <- nba_data$champs == 1
nba_data


gg1 <- ggplot(nba_data, aes(x=payroll, y=win_p)) +
        geom_point(aes(color= is_champ)) +
        labs(x="Payroll", y="Winning Percentage", fill= "Champtions") + 
        geom_smooth(method=lm) #add regression line

gg1 + facet_wrap( ~ cut(Year, breaks =5), ncol=2)
```

